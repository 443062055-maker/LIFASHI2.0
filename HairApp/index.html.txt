<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”·å£«å‘å‹æ²Ÿé€šç¥å™¨ - æç®€ç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- é…ç½® Tailwind ä»¥ä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1e293b', // Slate-900
                        'secondary': '#2563eb', // Blue-600
                        'accent': '#ec4899', // Pink-500
                    }
                }
            }
        }
    </script>
    <style>
        /* ç¡®ä¿é¡µé¢ä¸»ä½“å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f1f5f9; /* Slate-100 */
        }
        #app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 25px rgba(0,0,0,0.1);
        }
        /* ç§»åŠ¨ç«¯å®‰å…¨åŒºåŸŸåº•éƒ¨å¡«å…… */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
    </style>
</head>
<body class="font-sans">

<div id="app-container" class="max-w-md mx-auto">
    <!-- ä¸»åº”ç”¨è§†å›¾å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
    <div id="main-view" class="flex-1 overflow-y-auto"></div>

    <!-- åº•éƒ¨å¯¼èˆªå ä½ç¬¦ -->
    <div id="footer-nav" class="safe-area-bottom"></div>
</div>

<script>
    // --- å›¾æ ‡ç»„ä»¶ (Lucide-React æ›¿æ¢) ---
    const Icon = (name, classes = 'w-5 h-5', strokeWidth = 2) => {
        const icons = {
            Scissors: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="6" r="3"/><path d="M8.12 8.12 12 12"/><path d="M20 4 8.12 15.88"/><line x1="14.47" x2="20" y1="14.47" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/><circle cx="6" cy="18" r="3"/></svg>`,
            ChevronRight: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
            User: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
            Camera: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>`,
            Check: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`,
            Clock: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            Lock: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
            Heart: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`,
            ThumbsDown: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-3.34a4.34 4.34 0 0 0 1.77-3.77A4.34 4.34 0 0 0 17 14Z"/><path d="M15 14h6"/><path d="M15 18h4"/></svg>`,
            Undo2: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14 4 9l5-5"/><path d="M20 20v-4.41a2 2 0 0 0-.58-1.42l-4.12-4.12"/></svg>`,
            RefreshCw: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-5.5 1.5l3.5 3.5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 5.5-1.5l-3.5-3.5"/></svg>`,
            Save: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.41a2 2 0 0 0-.29-1.42L16.42 2.71A2 2 0 0 0 15 2z"/><path d="M10 12l2 2 4-4"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>`,
            Ruler: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22.5h-6l1-5.5v-11l5-2z"/><path d="M9 17h11.5a1.5 1.5 0 0 0 0-3H9"/><path d="M15 5.5h-11.5a1.5 1.5 0 0 0 0 3H15"/></svg>`,
            Crown: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m2 14 3-3 2 4 3-3 2 4 3-3 2 4 3-3 2 4"/><path d="M16 17 21.5 12.5a2.41 2.41 0 0 0-1.87-4.18H4.37a2.41 2.41 0 0 0-1.87 4.18L8 17"/><line x1="12" x2="12" y1="17" y2="22"/></svg>`,
            ImageIcon: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>`,
            AlertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86 1.84 18a2 2 0 0 0 1.71 3h18.9a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" stroke-width="${strokeWidth}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
        };
        return icons[name] || '';
    };

    // --- æ•°æ®é…ç½® ---
    // Placeholder Image Generator. Using white text on dark background for clarity.
    const getImg = (text, bg = '1e293b', fg = 'ffffff') => 
        `https://placehold.co/400x300/${bg}/${fg}/png?text=${encodeURIComponent(text)}`;

    const OPTIONS = {
        sides: [
            { id: 'natural', label: 'è‡ªç„¶ä¿ç•™', desc: 'ç›–ä½è€³æœµæˆ–åŠè€³ï¼Œä¸æ¨å…‰', icon: 'ğŸ‘‚', image: getImg('è‡ªç„¶ä¿ç•™', 'f8fafc', '1e293b') },
            { id: 'trim', label: 'ä¿®å‰ªæœå¸–', desc: 'éœ²å‡ºè€³æœµï¼Œé¬“è§’ä¿®çŸ­ä½†ä¸æ¨å…‰', icon: 'âœ‚ï¸', image: getImg('ä¿®å‰ªæœå¸–', 'f8fafc', '1e293b') },
            { id: 'fade-low', label: 'ä½ä½æ¸å˜', desc: 'é¬“è§’æ¨ç™½ï¼Œå‘ä¸Šè‡ªç„¶è¿‡æ¸¡', icon: 'ğŸ“‰', image: getImg('ä½ä½æ¸å˜') },
            { id: 'fade-high', label: 'ç¾å¼é“²é’', desc: 'ä¸¤è¾¹æ¨å¾—å¾ˆé«˜å¾ˆå…‰', icon: 'ğŸ‡ºğŸ‡¸', image: getImg('é«˜ä½é“²é’') },
            { id: 'two-block', label: 'ä¸¤åˆ†åŒº/æç©º', desc: 'é‡Œé¢æ¨çŸ­ï¼Œå¤–é¢å¤´å‘ç›–ä¸‹æ¥', icon: 'ğŸ§±', image: getImg('ä¸¤åˆ†åŒº') },
        ],
        top: [
            { id: 'short', label: 'å¯¸å¤´/çŸ­æ¯›åˆº', desc: 'æ— éœ€æ‰“ç†ï¼Œç¡¬æœ—', icon: 'ğŸ§Š', image: getImg('çŸ­æ¯›åˆº') },
            { id: 'texture', label: 'ç¢å‘/çº¹ç†', desc: 'é€‚åˆæŠ“å‘èœ¡ï¼Œæœ‰å±‚æ¬¡æ„Ÿ', icon: 'ğŸŒŠ', image: getImg('ç¢å‘çº¹ç†') },
            { id: 'side-part', label: 'åˆ†å¤´/æ²¹å¤´', desc: 'äºŒå…«/ä¸‰ä¸ƒåˆ†', icon: 'ğŸ¤µ', image: getImg('ä¾§åˆ†/æ²¹å¤´') },
            { id: 'perm', label: 'çƒ«å‘/å·å‘', desc: 'é’¢å¤¹çƒ«/é”¡çº¸çƒ«ç­‰', icon: 'ğŸŒ€', image: getImg('çƒ«å‘/å·å‘') },
            { id: 'long', label: 'æ­¦å£«å¤´/æ‰å‘', desc: 'é•¿å‘æ‰èµ·æ¥', icon: 'ğŸ¦', image: getImg('é•¿å‘/æ‰å‘') },
        ],
        bangs: [
            { id: 'none', label: 'æ— /éœ²é¢å¤´', desc: 'èƒŒå¤´æˆ–é£æœºå¤´', icon: 'â˜€ï¸', image: getImg('éœ²é¢å¤´', 'f8fafc', '1e293b') },
            { id: 'crop', label: 'æ —å­å¤´/é½åˆ˜æµ·', desc: 'çŸ­ä¸”é½ï¼Œå‡é¾„', icon: 'ğŸŒ°', image: getImg('æ —å­å¤´') },
            { id: 'comma', label: 'é€—å·/æ‹¬å·', desc: 'éŸ©å¼é€ å‹ï¼Œå‘å°¾å†…æ‰£', icon: 'ğŸ‡°ğŸ‡·', image: getImg('é€—å·/æ‹¬å·') },
            { id: 'eyebrow', label: 'ç¢ç›–/è¿‡çœ‰', desc: 'é•¿åˆ˜æµ·ï¼Œé®ç›–é¢å¤´', icon: 'ğŸ˜', image: getImg('ç¢ç›–/è¿‡çœ‰') },
        ],
        back: [
            { id: 'natural', label: 'è‡ªç„¶ç¢å‘', desc: 'è¾¹ç•ŒæŸ”å’Œ', icon: 'ğŸŒ¿', image: getImg('è‡ªç„¶ç¢å‘', 'f8fafc', '1e293b') },
            { id: 'square', label: 'æ–¹å½¢è¾¹ç•Œ', desc: 'ç¡¬æœ—ç›´çº¿', icon: 'â¬œ', image: getImg('æ–¹å½¢è¾¹ç•Œ') },
            { id: 'taper', label: 'æ¸å˜æ¨çŸ­', desc: 'ç”±çŸ­åˆ°é•¿è¿‡æ¸¡', icon: 'ğŸ“', image: getImg('æ¸å˜æ¨çŸ­') },
        ],
        donts: [
            'åˆ‡è®°ä¸è¦æ‰“å¤ªè–„',
            'åˆ˜æµ·ä¸è¦å‰ªå¤ªçŸ­',
            'é¬“è§’ä¸è¦æ¨å¤ªé’',
            'ä¸è¦ç”¨æ¨å­ï¼Œå…¨æ‰‹å‰ª',
            'å¤´é¡¶ä¸è¦å‰ªå¤ªçŸ­',
            'ä¸è¦ç”¨å¤ªå¤šå‘èƒ¶',
        ]
    };

    const CURRENT_LENGTHS = [
        { id: 'very_short', label: 'è´´çš®/å¯¸å¤´', cm: '< 3cm', level: 1, avgCm: 1.5 },
        { id: 'short', label: 'è€³ä¸ŠçŸ­å‘', cm: '3-8cm', level: 2, avgCm: 5 },
        { id: 'medium', label: 'ç›–è€³/ä¸­å‘', cm: '8-15cm', level: 3, avgCm: 12 },
        { id: 'long', label: 'åŠè‚©/é•¿å‘', cm: '> 15cm', level: 4, avgCm: 20 },
    ];

    const DEFAULT_STYLES = [
        { 
            id: 'buzz', name: 'ç¡¬æ±‰å¯¸å¤´', desc: 'å¹²å‡€åˆ©è½ï¼Œæ— éœ€æ‰“ç†', minLengthCm: 1,
            image: getImg('ç¡¬æ±‰å¯¸å¤´', '1e293b', 'ffffff'),
            config: { sides: OPTIONS.sides[3], top: OPTIONS.top[0], bangs: OPTIONS.bangs[0], back: OPTIONS.back[2] } 
        },
        { 
            id: 'crop', name: 'æ —å­å¤´', desc: 'é€‚åˆäºšæ´²ç”·ç”Ÿï¼Œä¿®é¥°å‘é™…çº¿', minLengthCm: 4,
            image: getImg('æ —å­å¤´', '2563eb', 'ffffff'),
            config: { sides: OPTIONS.sides[4], top: OPTIONS.top[0], bangs: OPTIONS.bangs[1], back: OPTIONS.back[0] } 
        },
        { 
            id: 'side_part', name: 'å•†åŠ¡ä¾§åˆ†', desc: 'æˆç†Ÿç¨³é‡ï¼Œé€‚åˆä¸Šç­æ—', minLengthCm: 8,
            image: getImg('å•†åŠ¡ä¾§åˆ†', 'ec4899', 'ffffff'),
            config: { sides: OPTIONS.sides[2], top: OPTIONS.top[2], bangs: OPTIONS.bangs[0], back: OPTIONS.back[2] } 
        },
    ];

    const GROWTH_RATE = 1.2;
    const calculateGrowthTime = (currentLevel, targetMinCm) => {
        const current = CURRENT_LENGTHS.find(l => l.level === currentLevel);
        if (!current) return 0;
        const diff = targetMinCm - current.avgCm;
        return diff <= 0 ? 0 : Math.ceil(diff / GROWTH_RATE);
    };

    // --- çŠ¶æ€ç®¡ç† (ä½¿ç”¨å…¨å±€å¯¹è±¡) ---
    let state = {
        step: 0,
        appMode: 'edit', // 'edit', 'pending_approval', 'approved', 'self_approved'
        totalSteps: 5, // ç§»é™¤ç…§ç‰‡ä¸Šä¼ ï¼Œæ€»æ­¥æ•°å‡å°‘
        userData: { 
            currentLengthLevel: 2, 
            // photo: null // ç§»é™¤ photo çŠ¶æ€
        },
        preferences: {
            selectedStyleId: null, 
            growthTime: 0,
            sides: null, 
            top: null, 
            bangs: null, 
            back: null,
            customDonts: [], 
            notes: '', 
            lengthChange: 1, 
            lengthMode: 'cut', 
        },
        dynamicStyles: DEFAULT_STYLES
    };

    // --- è§†å›¾æ¸²æŸ“å™¨ ---
    const $ = (id) => document.getElementById(id);
    const render = () => {
        const mainView = $('main-view');
        const footerNav = $('footer-nav');

        // æ¸²æŸ“é¡¶éƒ¨æ 
        const headerHTML = state.step > 0 && state.step < state.totalSteps - 1 ? 
            `<div class="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center z-50">
                <h1 class="font-bold text-slate-800 flex items-center gap-2">${Icon('Scissors', 'w-5 h-5 text-secondary')} å‘å‹å®šåˆ¶</h1>
                <button id="reset-button" class="text-slate-400 hover:text-red-500 transition-colors">${Icon('RefreshCw', 'w-5 h-5')}</button>
            </div>` : '';
        
        mainView.innerHTML = headerHTML + getStepContent(state.step);
        footerNav.innerHTML = getFooterNav();

        // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        bindEventListeners();
    };

    // --- æ¨¡æ€æ¡†æ›¿ä»£ alert/confirm ---
    const showModal = (message, isConfirm = false, onConfirm = () => {}) => {
        const modalId = 'custom-modal';
        let modal = document.getElementById(modalId);
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0';
            document.body.appendChild(modal);
        }

        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-95 transition-transform duration-300">
                <p class="text-lg font-semibold text-slate-800 mb-4">${message}</p>
                <div class="flex justify-end gap-3">
                    ${isConfirm ? 
                        `<button id="modal-cancel" class="px-4 py-2 text-slate-500 bg-slate-100 rounded-lg hover:bg-slate-200">å–æ¶ˆ</button>
                         <button id="modal-confirm" class="px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600">ç¡®è®¤</button>` :
                        `<button id="modal-ok" class="px-4 py-2 text-white bg-secondary rounded-lg hover:bg-secondary/90">å¥½çš„</button>`
                    }
                </div>
            </div>
        `;

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('div').classList.remove('scale-95');
        });

        const closeModal = () => {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.remove(), 300);
        };

        if (isConfirm) {
            $('modal-confirm').onclick = () => { closeModal(); onConfirm(); };
            $('modal-cancel').onclick = closeModal;
        } else {
            $('modal-ok').onclick = closeModal;
        }
    };

    // --- é¡µé¢å†…å®¹ç”Ÿæˆå‡½æ•° ---

    const ImageOptionCard = (item, category, selected, small = false) => {
        const isSelected = selected === item.id;
        return `
            <button data-category="${category}" data-id="${item.id}"
                class="image-option-card relative group overflow-hidden rounded-xl border-2 transition-all duration-200 text-left flex flex-col 
                ${isSelected 
                    ? 'border-secondary ring-1 ring-secondary shadow-md transform scale-[1.02]' 
                    : 'border-slate-200 bg-white hover:border-blue-300'
                }">
                <div class="w-full bg-slate-100 relative ${small ? 'h-24' : 'h-32'}">
                    <img src="${item.image}" alt="${item.label}"
                        class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity"
                        onerror="this.onerror=null;this.src='${getImg(item.label)}';"
                    />
                    ${isSelected ? `
                        <div class="absolute inset-0 bg-secondary/20 flex items-center justify-center">
                            <div class="bg-secondary text-white rounded-full p-1 shadow-lg">${Icon('Check', 'w-5 h-5', 3)}</div>
                        </div>` : ''}
                </div>
                <div class="p-3 flex-1 flex flex-col justify-center bg-white">
                    <div class="font-bold text-slate-800 text-sm flex items-center gap-1.5 mb-1">${item.label}</div>
                    <div class="text-xs text-slate-500 leading-tight">${item.desc}</div>
                </div>
            </button>
        `;
    };

    const getStepContent = (step) => {
        const { userData, preferences, appMode, dynamicStyles } = state;
        const main = $('main-view');
        
        // æ­¥éª¤ 0: æ¬¢è¿é¡µ
        if (step === 0) {
            return `
                <div class="flex flex-col items-center justify-center h-full p-6 text-center space-y-8 bg-primary text-white relative overflow-hidden min-h-[100vh]">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                        <div class="absolute top-10 left-[-20px] text-9xl opacity-20">âœ‚ï¸</div>
                        <div class="absolute bottom-20 right-[-20px] text-9xl opacity-20">ğŸ’ˆ</div>
                    </div>
                    <div class="w-24 h-24 bg-secondary rounded-2xl flex items-center justify-center shadow-[0_0_30px_rgba(37,99,235,0.5)] z-10">
                        ${Icon('Scissors', 'w-12 h-12 text-white')}
                    </div>
                    <div class="z-10">
                        <h1 class="text-3xl font-black mb-3 tracking-tight">ç”·å£«ç†å‘<br/>æ²Ÿé€šç¥å™¨</h1>
                        <p class="text-slate-400 max-w-xs mx-auto text-sm leading-relaxed">
                            ç²¾å‡†é€‰æ‹©ï¼Œæ‹’ç»ç¿»è½¦ã€‚<br/>
                            åŒ…å«<span class="text-white font-bold">ç•™å‘æ—¶é•¿é¢„ä¼°</span><br/>
                            åŠ <span class="text-accent font-bold">å¥³å‹å®¡æ‰¹æ¨¡å¼</span>ã€‚
                        </p>
                    </div>
                    <div class="z-10 w-full max-w-xs space-y-4">
                        <button id="next-step" class="w-full py-4 bg-white text-primary rounded-xl font-bold text-lg active:scale-95 transition-transform flex items-center justify-center gap-2 shadow-xl">
                            å¼€å§‹å®šåˆ¶ ${Icon('ChevronRight', 'w-5 h-5')}
                        </button>
                    </div>
                </div>
            `;
        }

        // æ­¥éª¤ 1: å½“å‰çŠ¶æ€ (ä»…é•¿åº¦)
        if (step === 1) {
            return `
                <div class="p-5 space-y-8">
                    <div class="space-y-2">
                        <h2 class="text-2xl font-black text-slate-900">1. ä½ çš„ç°çŠ¶</h2>
                        <p class="text-slate-500 text-sm">æˆ‘ä»¬ä¼šå¸®ä½ è®¡ç®—ä½ éœ€è¦ç•™å¤šä¹…å¤´å‘æ‰èƒ½è¾¾åˆ°ç›®æ ‡ã€‚</p>
                    </div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-700 uppercase">å½“å‰å¤´å‘é•¿åº¦</label>
                        <div class="grid grid-cols-2 gap-3">
                            ${CURRENT_LENGTHS.map((len) => `
                                <button data-level="${len.level}" id="len-level-${len.level}"
                                    class="length-select p-3 rounded-xl border-2 text-left transition-all 
                                    ${userData.currentLengthLevel === len.level ? 'border-secondary bg-blue-50 ring-1 ring-secondary' : 'border-slate-200 bg-white hover:border-slate-300'}">
                                    <div class="font-bold text-slate-800">${len.label}</div>
                                    <div class="text-xs text-slate-500">${len.cm}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ­¥éª¤ 2: ç›®æ ‡é£æ ¼
        if (step === 2) {
            return `
                <div class="p-5 space-y-6">
                    <div class="space-y-2">
                        <h2 class="text-2xl font-black text-slate-900">2. ç›®æ ‡é£æ ¼</h2>
                        <p class="text-slate-500 text-sm">åŒ…å«ç³»ç»Ÿé¢„è®¾æ¬¾å¼ã€‚</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${dynamicStyles.map(style => {
                            const monthsToGrow = calculateGrowthTime(userData.currentLengthLevel, style.minLengthCm);
                            const isReady = monthsToGrow === 0;
                            return `
                                <div data-style-id="${style.id}" class="preset-select group cursor-pointer bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md hover:border-secondary transition-all relative">
                                    <div class="h-40 overflow-hidden relative">
                                        <img src="${style.image}" alt="${style.name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 ${!isReady ? 'grayscale-[50%]' : ''}"
                                            onerror="this.onerror=null;this.src='${getImg(style.name)}';" />
                                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent flex items-end p-4">
                                            <div>
                                                <span class="text-white font-bold text-lg block">${style.name}</span>
                                                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold mt-1 ${isReady ? 'bg-green-500 text-white' : 'bg-yellow-500 text-primary'}">
                                                    ${isReady ? `${Icon('Check', 'w-2.5 h-2.5', 3)} é•¿åº¦è¾¾æ ‡` : `${Icon('Clock', 'w-2.5 h-2.5')} éœ€ç•™ ${monthsToGrow} ä¸ªæœˆ`}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <p class="text-xs text-slate-500 mb-3">${style.desc}</p>
                                        <div class="flex gap-2 text-[10px] text-slate-600">
                                            <span class="bg-slate-100 px-2 py-1 rounded">${style.config.sides.label}</span>
                                            <span class="bg-slate-100 px-2 py-1 rounded">${style.config.bangs.label}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        <button id="custom-select" class="w-full py-4 text-sm text-slate-500 font-medium border-2 border-dashed border-slate-300 rounded-xl hover:border-slate-400 hover:text-slate-700">
                            è·³è¿‡æ¨èï¼Œæˆ‘è‡ªå·±è®¾ç½®å‚æ•°
                        </button>
                    </div>
                </div>
            `;
        }

        // æ­¥éª¤ 3: ä¾§/å ç»†èŠ‚
        if (step === 3) {
            return `
                <div class="p-5 space-y-8">
                    <div class="flex items-center justify-between"><h2 class="text-xl font-bold text-slate-900">3. ä¾§/å ç»†èŠ‚</h2></div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2">ä¸¤ä¾§ Sides</label>
                        <div class="grid grid-cols-2 gap-3">
                            ${OPTIONS.sides.map(opt => ImageOptionCard(opt, 'sides', preferences.sides?.id)).join('')}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-500 uppercase flex items-center gap-2">åé¢ˆ Back</label>
                        <div class="grid grid-cols-3 gap-2">
                            ${OPTIONS.back.map(opt => ImageOptionCard(opt, 'back', preferences.back?.id, true)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ­¥éª¤ 4: é¡¶/å‰ ç»†èŠ‚
        if (step === 4) {
            return `
                <div class="p-5 space-y-8">
                    <div class="flex items-center justify-between"><h2 class="text-xl font-bold text-slate-900">4. é¡¶/å‰ ç»†èŠ‚</h2></div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-500 uppercase">å¤´é¡¶ Top</label>
                        <div class="grid grid-cols-2 gap-3">
                            ${OPTIONS.top.map(opt => ImageOptionCard(opt, 'top', preferences.top?.id)).join('')}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-slate-500 uppercase">åˆ˜æµ· Bangs</label>
                        <div class="grid grid-cols-2 gap-3">
                            ${OPTIONS.bangs.map(opt => ImageOptionCard(opt, 'bangs', preferences.bangs?.id)).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 space-y-4 shadow-sm">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-slate-700 flex items-center gap-2">${Icon('Ruler', 'w-4 h-4')} æ•´ä½“é•¿åº¦å¾®è°ƒ</label>
                            <div class="bg-slate-100 rounded-lg p-0.5 flex text-xs" id="length-mode-toggle">
                                <button data-mode="cut" class="px-3 py-1.5 rounded-md transition-all ${preferences.lengthMode === 'cut' ? 'bg-white text-secondary shadow-sm font-bold' : 'text-slate-500'}">å‰ªæ‰</button>
                                <button data-mode="retain" class="px-3 py-1.5 rounded-md transition-all ${preferences.lengthMode === 'retain' ? 'bg-white text-secondary shadow-sm font-bold' : 'text-slate-500'}">ä¿ç•™</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <input type="range" min="0.5" max="5" step="0.5" value="${preferences.lengthChange}" id="length-slider" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-secondary" />
                            <div id="length-display" class="bg-blue-50 text-secondary px-2 py-1 rounded font-mono font-bold w-16 text-center">${preferences.lengthChange}cm</div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h3 class="text-sm font-bold text-slate-500 uppercase flex items-center gap-1">${Icon('AlertTriangle', 'w-4 h-4')} ç†å‘é¿é›·é‡ç‚¹</h3>
                        <div class="grid grid-cols-2 gap-2">
                            ${OPTIONS.donts.map((d, i) => `
                                <button data-dont="${d}" class="dont-toggle px-3 py-2 text-sm rounded-lg border-2 transition-all text-left 
                                    ${preferences.customDonts.includes(d) ? 'bg-red-500 text-white border-red-500 font-semibold' : 'bg-white text-slate-700 border-slate-200 hover:border-red-300'}">
                                    ${preferences.customDonts.includes(d) ? Icon('X', 'w-4 h-4 inline-block align-text-bottom mr-1', 3) : ''}
                                    ${d}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label for="notes" class="text-sm font-bold text-slate-500 uppercase">ç‰¹æ®Šå¤‡æ³¨ (ç»™å‘å‹å¸ˆ)</label>
                        <textarea id="notes" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-secondary focus:border-secondary transition-colors" rows="3" placeholder="ä¾‹å¦‚ï¼šå¤´é¡¶è‡ªç„¶å·ä¸è¦å‰ªå¤ªçŸ­">${preferences.notes}</textarea>
                    </div>
                </div>
            `;
        }

        // æ­¥éª¤ 5: é¢„è§ˆ / å®¡æ‰¹ (æ–°çš„ Step 5)
        if (step === state.totalSteps - 1) {
            if (appMode === 'pending_approval') {
                const styleName = preferences.selectedStyleId ? dynamicStyles.find(s=>s.id===preferences.selectedStyleId)?.name : 'è‡ªå®šä¹‰å‘å‹';
                return `
                    <div class="h-full bg-pink-50 flex flex-col items-center pt-10 px-6 relative min-h-[100vh]">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-accent to-purple-600"></div>
                        <div class="bg-white p-4 rounded-full shadow-xl mb-6 ring-4 ring-pink-100">${Icon('Heart', 'w-10 h-10 text-accent fill-accent animate-pulse')}</div>
                        <h2 class="text-2xl font-black text-slate-800 mb-2">å¥³å‹å®¡æ‰¹æ¨¡å¼</h2>
                        <p class="text-slate-500 text-center mb-8">è¯·å¥³æœ‹å‹å®¡æ ¸è¯¥å‘å‹æ–¹æ¡ˆã€‚<br/>æ˜¯å¦åŒæ„ä»–å‰ªæˆè¿™æ ·ï¼Ÿ</p>
                        <div class="w-full bg-white rounded-2xl shadow-xl overflow-hidden mb-8 border border-pink-100">
                            <div class="h-48 bg-slate-200 relative">
                                <!-- ç”±äºç§»é™¤äº†ç…§ç‰‡ï¼Œè¿™é‡Œåªæ˜¾ç¤ºå ä½ç¬¦ -->
                                <div class="w-full h-full flex items-center justify-center bg-slate-100 text-slate-300">
                                    ${Icon('User', 'w-16 h-16')}
                                    <span class="absolute top-4 right-4 text-xs text-slate-400 font-medium">æ— ç…§ç‰‡é¢„è§ˆ</span>
                                </div>
                                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent flex items-end p-4">
                                    <div>
                                        <div class="font-bold text-lg text-white">${styleName}</div>
                                        ${preferences.growthTime > 0 ? `<div class="text-yellow-300 text-xs font-bold mt-1 flex items-center gap-1">${Icon('Clock', 'w-3 h-3')} éœ€è¦ç•™å‘çº¦ ${preferences.growthTime} ä¸ªæœˆ</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-slate-50 p-2 rounded"><span class="text-slate-400 block mb-1">ä¸¤ä¾§</span><span class="font-bold text-slate-700">${preferences.sides?.label || 'æœªæŒ‡å®š'}</span></div>
                                <div class="bg-slate-50 p-2 rounded"><span class="text-slate-400 block mb-1">åˆ˜æµ·</span><span class="font-bold text-slate-700">${preferences.bangs?.label || 'æœªæŒ‡å®š'}</span></div>
                                ${preferences.customDonts.length > 0 ? `<div class="col-span-2 bg-red-50 p-2 rounded text-white border border-red-500">${Icon('AlertTriangle', 'w-3 h-3 inline-block align-text-bottom mr-1')} <span class="font-bold">é¿é›·é‡ç‚¹ï¼š</span>${preferences.customDonts.join(', ')}</div>` : ''}
                            </div>
                        </div>
                        <div class="w-full flex gap-4 mt-auto mb-8">
                            <button id="approval-reject" class="flex-1 py-4 bg-white border-2 border-slate-200 text-slate-500 rounded-2xl font-bold flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform">${Icon('ThumbsDown', 'w-6 h-6')}é©³å›ä¿®æ”¹</button>
                            <button id="approval-approve" class="flex-1 py-4 bg-gradient-to-br from-accent to-purple-600 text-white rounded-2xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg shadow-pink-200 active:scale-95 transition-transform">${Icon('Heart', 'w-6 h-6 fill-white')}æ‰¹å‡†é€šè¿‡</button>
                        </div>
                    </div>
                `;
            } else {
                // æœ€ç»ˆæ€»ç»“å¡ç‰‡
                const styleName = preferences.selectedStyleId ? dynamicStyles.find(s=>s.id===preferences.selectedStyleId)?.name : 'è‡ªå®šä¹‰å‘å‹';
                const statusBadge = appMode === 'approved' ? 
                    `<span class="inline-block bg-accent text-white text-[10px] px-2 py-0.5 rounded-full font-bold mt-1 shadow-sm">${Icon('Heart', 'w-3 h-3 fill-white inline-block align-text-bottom')} å¥³å‹å·²æ‰¹å‡†</span>` : 
                    `<span class="inline-block bg-primary text-yellow-400 border border-yellow-400 text-[10px] px-2 py-0.5 rounded-full font-bold mt-1 shadow-sm flex items-center gap-1 w-fit">${Icon('Crown', 'w-3 h-3 fill-current')} æœ¬äººå·²ç¡®è®¤</span>`;

                return `
                    <div class="h-full bg-slate-900 p-4 flex flex-col text-white min-h-[100vh]">
                        <div class="flex-1 bg-white text-slate-900 rounded-2xl overflow-hidden flex flex-col shadow-2xl relative">
                            <div class="bg-secondary p-4 text-white flex justify-between items-start">
                                <div>
                                    <h2 class="font-black text-2xl flex items-center gap-2">ç†å‘éœ€æ±‚å• ${Icon('Scissors', 'w-5 h-5 text-blue-200')}</h2>
                                    ${(appMode === 'approved' || appMode === 'self_approved') ? statusBadge : `<span class="text-white/80 text-sm">å‘å‹ï¼š${styleName}</span>`}
                                </div>
                                <!-- æ— ç…§ç‰‡é¢„è§ˆå ä½ç¬¦ -->
                                <div class="w-16 h-16 rounded-lg border-2 border-white/30 flex items-center justify-center bg-blue-700">${Icon('User', 'w-8 h-8 text-blue-300')}</div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 space-y-5">
                                ${preferences.growthTime > 0 ? `
                                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-xl flex items-start gap-3">
                                        ${Icon('Clock', 'w-5 h-5 text-yellow-600 mt-0.5')}
                                        <div>
                                            <h4 class="font-bold text-yellow-800 text-sm">å…»æˆè®¡åˆ’ä¸­</h4>
                                            <p class="text-yellow-700 text-xs mt-1">æ­¤å‘å‹éœ€è¦æ›´é•¿çš„å¤´å‘ã€‚é¢„è®¡è¿˜éœ€ç•™å‘ <span class="font-bold text-lg">${preferences.growthTime}</span> ä¸ªæœˆã€‚<br/>æœ¬æ¬¡ç†å‘è¯·ä»¥ <span class="font-bold">â€œç•™é•¿è¿‡æ¸¡ï¼Œåªä¿®è½®å»“â€</span> ä¸ºä¸»ã€‚</p>
                                        </div>
                                    </div>
                                ` : ''}
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-xs font-bold text-slate-400 uppercase flex items-center gap-1">${Icon('AlertTriangle', 'w-3 h-3')} é¿é›·åŒº</h3>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        ${preferences.customDonts.length > 0 ? preferences.customDonts.map((d, i) => `<span key="${i}" class="px-2 py-1 text-xs rounded border bg-red-500 text-white border-red-500 font-bold">${d}</span>`).join('') : '<span class="text-xs text-slate-400">æ— ç‰¹æ®Šé¿é›·</span>'}
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    ${[{ label: 'ä¸¤ä¾§', obj: preferences.sides }, { label: 'å¤´é¡¶', obj: preferences.top }, { label: 'åˆ˜æµ·', obj: preferences.bangs }, { label: 'åé¢ˆ', obj: preferences.back }].map((part, idx) => `
                                        <div class="bg-slate-50 rounded-lg border border-slate-100 overflow-hidden flex flex-col">
                                            <div class="h-16 bg-slate-200 relative">
                                                ${part.obj?.image ? `<img src="${part.obj.image}" class="w-full h-full object-cover opacity-80" alt="" />` : `<div class="w-full h-full flex items-center justify-center text-slate-400">${Icon('ImageIcon', 'w-4 h-4')}</div>`}
                                                <div class="absolute top-0 left-0 bg-secondary text-white text-[10px] px-1.5 py-0.5 rounded-br font-bold">${part.label}</div>
                                            </div>
                                            <div class="p-2"><div class="font-bold text-sm text-slate-800 line-clamp-1">${part.obj?.label || 'æœªæŒ‡å®š'}</div></div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm">
                                    <div class="flex items-center gap-2 text-slate-800 font-bold mb-1">${Icon('Ruler', 'w-4 h-4')} é•¿åº¦æ§åˆ¶</div>
                                    <div class="text-slate-600">æ•´ä½“${preferences.lengthMode === 'cut' ? 'å‰ªå»' : 'ä¿ç•™'} <span class="font-bold text-lg text-slate-900">${preferences.lengthChange}cm</span> å·¦å³</div>
                                </div>
                                ${preferences.notes ? `
                                    <div>
                                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-1">ç‰¹æ®Šå¤‡æ³¨</h3>
                                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-slate-800 text-sm">${preferences.notes}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="mt-4 flex-shrink-0 w-full">
                            ${(appMode === 'approved' || appMode === 'self_approved') ? `
                                <div class="flex gap-3">
                                    <button id="summary-edit" class="px-4 py-3 rounded-xl bg-slate-800 text-slate-400 font-bold">ä¿®æ”¹</button>
                                    <button id="summary-save" class="flex-1 py-3 rounded-xl bg-green-500 text-white font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">${Icon('Save', 'w-5 h-5')} ä¿å­˜æœ€ç»ˆå¡ç‰‡ (æˆªå›¾)</button>
                                </div>
                            ` : `
                                <div class="flex flex-col gap-2">
                                    <button id="to-approval" class="w-full py-3 rounded-xl bg-accent text-white font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">${Icon('Lock', 'w-5 h-5')} æäº¤å¥³å‹å®¡æ‰¹ (ä¿å‘½è¦ç´§)</button>
                                    <div class="flex gap-3">
                                        <button id="summary-back" class="px-4 py-3 rounded-xl bg-slate-800 text-slate-400 font-bold">è¿”å›</button>
                                        <button id="self-approve" class="flex-1 py-3 rounded-xl bg-secondary text-white font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">${Icon('Crown', 'w-5 h-5')} æˆ‘è‡ªå·±åšä¸» (å•èº«ç‰ˆ)</button>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
        }
    };

    const getFooterNav = () => {
        // è°ƒæ•´æ­¥æ•°æŒ‡ç¤ºå™¨ï¼šæ€»æ­¥æ•°-2æ˜¯å› ä¸º Step 0 (æ¬¢è¿é¡µ) å’Œ æœ€åä¸€ä¸ª Step (æ€»ç»“é¡µ) ä¸ç®—åœ¨ä¸­é—´æµç¨‹ä¸­
        const currentFlowStep = state.step; 
        if (state.step === 0 || state.step === state.totalSteps - 1) return '';
        if (state.appMode === 'pending_approval') return ''; // å®¡æ‰¹é¡µæœ‰è‡ªå·±çš„æŒ‰é’®

        return `
            <div class="p-4 bg-white border-t border-slate-200 flex justify-between items-center z-50">
                <button id="prev-step" class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded-lg flex items-center gap-1">${Icon('Undo2', 'w-4 h-4')} ä¸Šä¸€æ­¥</button>
                <div class="flex gap-1">
                    ${[...Array(state.totalSteps - 1)].map((_, i) => `<div class="h-1.5 rounded-full transition-all ${i + 1 === currentFlowStep ? 'w-6 bg-secondary' : 'w-2 bg-slate-200'}" />`).join('')}
                </div>
                <button id="next-step" class="px-6 py-2 bg-primary text-white rounded-lg font-semibold shadow-lg hover:bg-slate-800 flex items-center gap-2">
                    ${currentFlowStep === state.totalSteps - 2 ? 'ç”Ÿæˆé¢„è§ˆ' : 'ä¸‹ä¸€æ­¥'} ${Icon('ChevronRight', 'w-4 h-4')}
                </button>
            </div>
        `;
    };

    // --- çŠ¶æ€æ“ä½œå‡½æ•° ---

    const updateState = (newState) => {
        state = { ...state, ...newState };
        render(); // æ¯æ¬¡çŠ¶æ€æ›´æ–°åé‡æ–°æ¸²æŸ“
    };

    const updateUserData = (key, value) => {
        state.userData[key] = value;
        render();
    };

    const updatePreferences = (key, value) => {
        state.preferences[key] = value;
        render();
    };

    const nextStep = () => updateState({ step: Math.min(state.step + 1, state.totalSteps - 1) });
    const prevStep = () => updateState({ step: Math.max(state.step - 1, 0) });
    
    const reset = () => showModal("é‡ç½®æ‰€æœ‰é€‰é¡¹ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å·²é€‰çš„å‘å‹å’Œåå¥½è®¾ç½®ã€‚", true, () => {
        state = {
            step: 0,
            appMode: 'edit',
            totalSteps: 5, // é‡ç½®æ—¶ä¹Ÿè¦ä¿æŒæ€»æ­¥æ•°æ­£ç¡®
            userData: { currentLengthLevel: 2 }, // ç§»é™¤ photo
            preferences: {
                selectedStyleId: null, growthTime: 0,
                sides: null, top: null, bangs: null, back: null,
                customDonts: [], notes: '', lengthChange: 1, lengthMode: 'cut', 
            },
            dynamicStyles: DEFAULT_STYLES
        };
        render();
    });

    const applyPreset = (style) => {
        const months = calculateGrowthTime(state.userData.currentLengthLevel, style.minLengthCm);
        updateState({
            preferences: {
                ...state.preferences, 
                selectedStyleId: style.id, 
                growthTime: months,
                sides: style.config.sides, 
                top: style.config.top, 
                bangs: style.config.bangs, 
                back: style.config.back,
            }
        });
        nextStep();
    };
    
    // --- äº‹ä»¶ç»‘å®š ---

    const bindEventListeners = () => {
        // å¯¼èˆªæŒ‰é’®
        const nextBtn = $('next-step');
        if (nextBtn) nextBtn.onclick = nextStep;

        const prevBtn = $('prev-step');
        if (prevBtn) prevBtn.onclick = prevStep;
        
        const resetBtn = $('reset-button');
        if (resetBtn) resetBtn.onclick = reset;

        // æ­¥éª¤ 1: é•¿åº¦é€‰æ‹©
        document.querySelectorAll('.length-select').forEach(btn => {
            btn.onclick = () => updateUserData('currentLengthLevel', parseInt(btn.dataset.level));
        });

        // æ­¥éª¤ 2: é¢„è®¾é€‰æ‹©
        document.querySelectorAll('.preset-select').forEach(btn => {
            btn.onclick = () => {
                const styleId = btn.dataset.styleId;
                const style = DEFAULT_STYLES.find(s => s.id === styleId);
                if (style) applyPreset(style);
            };
        });
        const customSelectBtn = $('custom-select');
        if (customSelectBtn) {
            // è®¾ç½®è‡ªå®šä¹‰å‘å‹çš„é»˜è®¤é…ç½®
            customSelectBtn.onclick = () => applyPreset({ 
                id: 'custom', 
                name: 'å®Œå…¨è‡ªå®šä¹‰', 
                minLengthCm: 0, 
                config: { 
                    sides: OPTIONS.sides[0], 
                    top: OPTIONS.top[0], 
                    bangs: OPTIONS.bangs[0], 
                    back: OPTIONS.back[0] 
                } 
            });
        }

        // æ­¥éª¤ 3 & 4: ç»†èŠ‚é€‰æ‹© (æ­¥éª¤è°ƒæ•´ï¼Œç°åœ¨æ˜¯ 2 & 3)
        document.querySelectorAll('.image-option-card').forEach(btn => {
            btn.onclick = () => {
                const category = btn.dataset.category;
                const id = btn.dataset.id;
                const options = OPTIONS[category];
                const selectedOption = options.find(opt => opt.id === id);
                if (selectedOption) {
                    updatePreferences(category, selectedOption);
                }
            };
        });
        
        // æ­¥éª¤ 4: é•¿åº¦å¾®è°ƒ
        const lengthSlider = $('length-slider');
        const lengthDisplay = $('length-display');
        if (lengthSlider && lengthDisplay) {
            lengthSlider.oninput = (e) => {
                const value = e.target.value;
                lengthDisplay.textContent = `${value}cm`;
                updatePreferences('lengthChange', parseFloat(value));
            };
        }
        
        const lengthModeToggle = $('length-mode-toggle');
        if (lengthModeToggle) {
            lengthModeToggle.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => updatePreferences('lengthMode', btn.dataset.mode);
            });
        }

        // æ­¥éª¤ 4: é¿é›·åŒº
        document.querySelectorAll('.dont-toggle').forEach(btn => {
            btn.onclick = () => {
                const item = btn.dataset.dont;
                const donts = state.preferences.customDonts;
                let newDonts;
                if (donts.includes(item)) {
                    newDonts = donts.filter(d => d !== item);
                } else {
                    newDonts = [...donts, item];
                }
                updatePreferences('customDonts', newDonts);
            };
        });

        // æ­¥éª¤ 4: ç‰¹æ®Šå¤‡æ³¨
        const notesTextarea = $('notes');
        if (notesTextarea) {
            notesTextarea.oninput = (e) => updatePreferences('notes', e.target.value);
        }

        // æ€»ç»“/å®¡æ‰¹é¡µ (ç°åœ¨æ˜¯ Step 5)
        const approvalRejectBtn = $('approval-reject');
        if (approvalRejectBtn) approvalRejectBtn.onclick = () => updateState({ appMode: 'edit', step: 4 }); // é©³å›ï¼Œå›åˆ°å®šåˆ¶é¡µ
        
        const approvalApproveBtn = $('approval-approve');
        if (approvalApproveBtn) approvalApproveBtn.onclick = () => updateState({ appMode: 'approved' }); // æ‰¹å‡†ï¼Œè¿›å…¥æ€»ç»“é¡µ
        
        const selfApproveBtn = $('self-approve');
        if (selfApproveBtn) selfApproveBtn.onclick = () => updateState({ appMode: 'self_approved' }); // è‡ªå·±åšä¸»ï¼Œè¿›å…¥æ€»ç»“é¡µ

        const summaryBackBtn = $('summary-back');
        if (summaryBackBtn) summaryBackBtn.onclick = prevStep; // æ€»ç»“é¡µè¿”å›
        
        const summaryEditBtn = $('summary-edit');
        if (summaryEditBtn) summaryEditBtn.onclick = () => updateState({ appMode: 'edit', step: 4 }); // æ€»ç»“é¡µä¿®æ”¹
        
        const toApprovalBtn = $('to-approval');
        if (toApprovalBtn) toApprovalBtn.onclick = () => updateState({ appMode: 'pending_approval' }); // æäº¤å®¡æ‰¹

        const summarySaveBtn = $('summary-save');
        if (summarySaveBtn) summarySaveBtn.onclick = () => showModal("è¯·å¯¹å½“å‰é¡µé¢è¿›è¡Œæˆªå›¾ä¿å­˜ï¼Œç„¶åå‡ºç¤ºç»™å‘å‹å¸ˆã€‚æœ¬åº”ç”¨ä¸ºæ¼”ç¤ºç‰ˆï¼Œæ— æ³•è‡ªåŠ¨ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°ã€‚", false);
    };


    // åˆå§‹æ¸²æŸ“
    window.onload = () => {
        render();
    };

</script>

</body>
</html>